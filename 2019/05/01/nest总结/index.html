<!DOCTYPE html><html lang="en-us"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"><title>nest总结 | duuliy</title><meta name="description" content="从express到koa再到现在的nest+Graphgl..."><meta name="generator" content="duuliy"><meta name="author" content="duuliy"><meta name="keywords"><meta name="HandheldFriendly" content="True"><meta name="MobileOptimized" content="320"><meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1,user-scalable=0"><link rel="stylesheet" type="text/css" href="/styles/screen.css"><link rel="apple-touch-icon" sizes="57x57" href="/images/logo.png"><link rel="apple-touch-icon" sizes="60x60" href="/images/logo.png"><link rel="apple-touch-icon" sizes="72x72" href="/images/logo.png"><link rel="apple-touch-icon" sizes="76x76" href="/images/logo.png"><link rel="apple-touch-icon" sizes="114x114" href="/images/logo.png"><link rel="apple-touch-icon" sizes="120x120" href="/images/logo.png"><link rel="apple-touch-icon" sizes="144x144" href="/images/logo.png"><link rel="apple-touch-icon" sizes="152x152" href="/images/logo.png"><link rel="apple-touch-icon" sizes="180x180" href="/images/logo.png"><link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png"><link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png"><link rel="icon" type="image/png" sizes="96x96" href="/images/favicon-96x96.png"><link rel="icon" type="image/png" sizes="128x128" href="/images/favicon-128.png"><link rel="icon" type="image/png" sizes="196x196" href="/images/favicon-196x196.png"><meta name="msapplication-TileColor" content="#FFFFFF"><meta name="msapplication-TileImage" content="logo.png"><meta name="msapplication-square70x70logo" content="logo.png"><meta name="msapplication-square150x150logo" content="logo.png"><meta name="msapplication-wide310x150logo" content="logo.png"><meta name="msapplication-square310x310logo" content="logo.png"><link rel="stylesheet" href="/css/prism.css" type="text/css"></head><body itemscope itemtype="https://schema.org/WebPage"><header itemscope itemtype="https://schema.org/WPHeader"><div class="logo"></div><h1><a href="/" alt="duuliy" title="duuliy" itemprop="headline">duuliy</a></h1><p itemprop="description"></p><nav itemscope itemtype="https://schema.org/SiteNavigationElement"><ul><li itemprop="name"><a href="/ " alt="主页" title="主页" itemprop="url">主页</a></li><li itemprop="name"><a href="/archives" alt="归档" title="归档" itemprop="url">归档</a></li><li itemprop="name"><a href="/about" alt="关于" title="关于" itemprop="url">关于</a></li></ul></nav><footer><div class="container beautiful-jekyll-footer"><div class="row"><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><p class="theme-by text-muted">Theme by
<a target="_blank" rel="noopener" href="https://github.com/mkkhedawat/clexy">clexy-hexo</a></p><p class="copyright text-muted">© duuliy • 2023</p></div></div></div></footer><div class="space"></div></header><main itemscope itemtype="https://schema.org/Blog"><article class="full"><h1 itemprop="headline" class="post-heading">nest总结</h1><span class="post-meta"></span><span class="page-tag-anchor">2019-5-1</span><br><br><p>&emsp;&emsp;从express到koa再到现在的nest+Graphgl, node的框架越来越棒了, 话说有没感觉它的写法和最近接触的堡垒机的ng7代码很像，哈哈，学了springboot之后,又会觉得两者思路上的相似。<br>一查资料果然印证猜想</p>
<h6 id="1-应用程序"><a href="#1-应用程序" class="headerlink" title="1.应用程序"></a>1.应用程序</h6><p>创建一个http服务</p>
<pre class=" language-js"><code class="language-js"><span class="token keyword">const</span> server <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">bootstrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">}</span>
<span class="token function">bootstrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
http<span class="token punctuation">.</span><span class="token function">createServer</span><span class="token punctuation">(</span>server<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<h6 id="2-导入module"><a href="#2-导入module" class="headerlink" title="2.导入module"></a>2.导入module</h6><pre class=" language-js"><code class="language-js">@<span class="token function">Module</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  imports<span class="token punctuation">:</span> <span class="token punctuation">[</span> <span class="token comment" spellcheck="true">//导入模块的列表</span>
    userGraphqlModule<span class="token punctuation">,</span>
    GraphQLModule<span class="token punctuation">.</span><span class="token function">forRoot</span><span class="token punctuation">(</span><span class="token punctuation">{</span>   <span class="token comment" spellcheck="true">//http://localhost:3000/graphql</span>
      path<span class="token punctuation">:</span> <span class="token string">'/graphql'</span><span class="token punctuation">,</span>
      typePaths<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'./**/*.graphql'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      definitions<span class="token punctuation">:</span> <span class="token punctuation">{</span>
        path<span class="token punctuation">:</span> <span class="token function">join</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span><span class="token function">cwd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'src/classGraphql/graphql.schema.ts'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment" spellcheck="true">//自动生成class</span>
        outputAs<span class="token punctuation">:</span> <span class="token string">'class'</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      installSubscriptionHandlers<span class="token punctuation">:</span> <span class="token boolean">true</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    UserModule<span class="token punctuation">,</span>
    CacheModule<span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true">//只有使用 @Get() 方式声明的节点会被缓存。</span>
    <span class="token comment" spellcheck="true">// ConfigModule</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  controllers<span class="token punctuation">:</span> <span class="token punctuation">[</span>AppController<span class="token punctuation">,</span> CatsController<span class="token punctuation">,</span> CarController<span class="token punctuation">,</span> ErrorController<span class="token punctuation">]</span><span class="token punctuation">,</span>
  providers<span class="token punctuation">:</span> <span class="token punctuation">[</span>
    WsGateway<span class="token punctuation">,</span>
    AppService<span class="token punctuation">,</span>
    CatsService<span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      provide<span class="token punctuation">:</span> APP_FILTER<span class="token punctuation">,</span>
      useClass<span class="token punctuation">:</span> HttpExceptionFilter<span class="token punctuation">,</span> <span class="token comment" spellcheck="true">//全局</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      provide<span class="token punctuation">:</span> APP_INTERCEPTOR<span class="token punctuation">,</span>
      useClass<span class="token punctuation">:</span>TimeoutInterceptor
    <span class="token punctuation">}</span>
    <span class="token comment" spellcheck="true">// {</span>
    <span class="token comment" spellcheck="true">//   provide: APP_INTERCEPTOR,</span>
    <span class="token comment" spellcheck="true">//   useClass: CacheInterceptor,  //全局缓存 不能和GraphQL  一起用</span>
    <span class="token comment" spellcheck="true">// }</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  exports<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// 由本模块提供并应在其他模块中可用的提供者的子集。</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment" spellcheck="true">// export class AppModule {}</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">AppModule</span> <span class="token keyword">implements</span> <span class="token class-name">NestModule</span> <span class="token punctuation">{</span>
  <span class="token function">configure</span><span class="token punctuation">(</span>consumer<span class="token punctuation">:</span> MiddlewareConsumer<span class="token punctuation">)</span> <span class="token punctuation">{</span></code></pre>
<h6 id="3-编写Controller"><a href="#3-编写Controller" class="headerlink" title="3.编写Controller"></a>3.编写Controller</h6><pre class=" language-js"><code class="language-js">@<span class="token function">Controller</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">AppController</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token keyword">private</span> readonly appService<span class="token punctuation">:</span> AppService<span class="token operator">&lt;</span>any<span class="token operator">></span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

  @<span class="token function">Get</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token comment" spellcheck="true">// @UsePipes(new JoiValidationPipe(createCatSchema))</span>
  @<span class="token function">UseInterceptors</span><span class="token punctuation">(</span>LoggingInterceptor<span class="token punctuation">)</span>
  <span class="token function">getHello</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span> string <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>appService<span class="token punctuation">.</span><span class="token function">getHello</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre>
<h6 id="4-查询serve"><a href="#4-查询serve" class="headerlink" title="4.查询serve"></a>4.查询serve</h6><pre class=" language-js"><code class="language-js">@<span class="token function">Injectable</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">UserService</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span>
    @<span class="token function">Inject</span><span class="token punctuation">(</span><span class="token string">'USER_REPOSITORY'</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> readonly usersRepository<span class="token punctuation">:</span> Repository<span class="token operator">&lt;</span>User<span class="token operator">></span>
  <span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

  <span class="token keyword">async</span> <span class="token function">findAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span> Promise<span class="token operator">&lt;</span>User<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>usersRepository<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre>
<p>还可以用Graphql</p>
<pre class=" language-js"><code class="language-js">@<span class="token function">Injectable</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">GraphqlService</span> <span class="token punctuation">{</span>
  <span class="token keyword">private</span> readonly users<span class="token punctuation">:</span> User<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">{</span> id<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span> userName<span class="token punctuation">:</span> <span class="token string">'duuliy1'</span><span class="token punctuation">,</span>sex<span class="token punctuation">:</span><span class="token number">1</span><span class="token punctuation">,</span>height<span class="token punctuation">:</span><span class="token number">1</span><span class="token punctuation">,</span>weight<span class="token punctuation">:</span><span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

  <span class="token function">create</span><span class="token punctuation">(</span>user<span class="token punctuation">:</span> User<span class="token punctuation">)</span><span class="token punctuation">:</span> User <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>users<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> user<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

   <span class="token keyword">async</span> <span class="token function">findAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span> Promise<span class="token operator">&lt;</span>User<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> body<span class="token operator">=</span><span class="token keyword">await</span> axios<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>TARGET_SERVER<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">mysql`</span></span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>resp <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// console.log('statusCode:', resp.status); // 返回请求的状态码</span>
        <span class="token comment" spellcheck="true">// console.log('body:', resp.data); // 返回回来的数据</span>
        <span class="token comment" spellcheck="true">//这里可以调用多个接口聚合数据</span>
        <span class="token keyword">return</span> resp<span class="token punctuation">.</span>data
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> body
  <span class="token punctuation">}</span></code></pre>
<h6 id="5-bean"><a href="#5-bean" class="headerlink" title="5.bean"></a>5.bean</h6><pre class=" language-js"><code class="language-js">@<span class="token function">Entity</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">//代表是bean的实体</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">User</span> <span class="token punctuation">{</span>
  @<span class="token function">ApiProperty</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  @<span class="token function">PrimaryGeneratedColumn</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">//代表主键</span>
  readonly id<span class="token operator">?</span><span class="token punctuation">:</span> number<span class="token punctuation">;</span>

  @<span class="token function">ApiProperty</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  @<span class="token function">Column</span><span class="token punctuation">(</span><span class="token punctuation">{</span> 
    type<span class="token punctuation">:</span> <span class="token string">'char'</span><span class="token punctuation">,</span>
    length<span class="token punctuation">:</span> <span class="token number">100</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  readonly userName<span class="token punctuation">:</span> string<span class="token punctuation">;</span>

  @<span class="token function">ApiProperty</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  @<span class="token function">Exclude</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true">//返回值排除此选项</span>
  @<span class="token function">Column</span><span class="token punctuation">(</span><span class="token punctuation">{</span> 
    type<span class="token punctuation">:</span> <span class="token string">'char'</span><span class="token punctuation">,</span>
    length<span class="token punctuation">:</span> <span class="token number">100</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  readonly password<span class="token punctuation">:</span> string<span class="token punctuation">;</span>
</code></pre>
<h6 id="6-连接池"><a href="#6-连接池" class="headerlink" title="6. 连接池"></a>6. 连接池</h6><pre class=" language-js"><code class="language-js"><span class="token keyword">export</span> <span class="token keyword">const</span> databaseProviders <span class="token operator">=</span> <span class="token punctuation">[</span>
  <span class="token punctuation">{</span>
    provide<span class="token punctuation">:</span> <span class="token string">'DATABASE_CONNECTION'</span><span class="token punctuation">,</span>
    useFactory<span class="token punctuation">:</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span>
      <span class="token keyword">await</span> <span class="token function">createConnection</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        type<span class="token punctuation">:</span> <span class="token string">'mysql'</span><span class="token punctuation">,</span>
        host<span class="token punctuation">:</span> <span class="token string">'localhost'</span><span class="token punctuation">,</span>
        port<span class="token punctuation">:</span> <span class="token number">3306</span><span class="token punctuation">,</span>
        username<span class="token punctuation">:</span> <span class="token string">'root'</span><span class="token punctuation">,</span>
        password<span class="token punctuation">:</span> <span class="token string">'root'</span><span class="token punctuation">,</span>
        database<span class="token punctuation">:</span> <span class="token string">''</span><span class="token punctuation">,</span>
        entities<span class="token punctuation">:</span> <span class="token punctuation">[</span>__dirname <span class="token operator">+</span> <span class="token string">'/../**/*.entity{.ts,.js}'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        synchronize<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">//同步</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span><span class="token punctuation">;</span></code></pre>
<h6 id="6-设置pipe-和filter"><a href="#6-设置pipe-和filter" class="headerlink" title="6.设置pipe 和filter"></a>6.设置pipe 和filter</h6><p>面向切面</p>
<pre class=" language-js"><code class="language-js">
@<span class="token function">Injectable</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">ValidationPipe</span> <span class="token keyword">implements</span> <span class="token class-name">PipeTransform</span><span class="token operator">&lt;</span>any<span class="token operator">></span> <span class="token punctuation">{</span>
  <span class="token keyword">async</span> <span class="token function">transform</span><span class="token punctuation">(</span>value<span class="token punctuation">:</span> any<span class="token punctuation">,</span> <span class="token punctuation">{</span> metatype <span class="token punctuation">}</span><span class="token punctuation">:</span> ArgumentMetadata<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>metatype <span class="token operator">||</span> <span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">toValidate</span><span class="token punctuation">(</span>metatype<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> value<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">const</span> object <span class="token operator">=</span> <span class="token function">plainToClass</span><span class="token punctuation">(</span>metatype<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> errors <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">validate</span><span class="token punctuation">(</span>object<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>errors<span class="token punctuation">.</span>length <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BadRequestException</span><span class="token punctuation">(</span><span class="token string">'Validation failed'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> value<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">private</span> <span class="token function">toValidate</span><span class="token punctuation">(</span>metatype<span class="token punctuation">:</span> Function<span class="token punctuation">)</span><span class="token punctuation">:</span> boolean <span class="token punctuation">{</span>
    <span class="token keyword">const</span> types<span class="token punctuation">:</span> Function<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span>String<span class="token punctuation">,</span> Boolean<span class="token punctuation">,</span> Number<span class="token punctuation">,</span> Array<span class="token punctuation">,</span> Object<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token operator">!</span>types<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span>metatype<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<pre class=" language-js"><code class="language-js">@<span class="token function">Catch</span><span class="token punctuation">(</span>HttpException<span class="token punctuation">)</span> <span class="token comment" spellcheck="true">//捕获http异常类型</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">HttpExceptionFilter</span> <span class="token keyword">implements</span> <span class="token class-name">ExceptionFilter</span> <span class="token punctuation">{</span>
  <span class="token keyword">catch</span><span class="token punctuation">(</span>exception<span class="token punctuation">:</span> HttpException<span class="token punctuation">,</span> host<span class="token punctuation">:</span> ArgumentsHost<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> ctx <span class="token operator">=</span> host<span class="token punctuation">.</span><span class="token function">switchToHttp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> response <span class="token operator">=</span> ctx<span class="token punctuation">.</span>getResponse<span class="token operator">&lt;</span>Response<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> request <span class="token operator">=</span> ctx<span class="token punctuation">.</span>getRequest<span class="token operator">&lt;</span>Request<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> status <span class="token operator">=</span>
      exception <span class="token keyword">instanceof</span> <span class="token class-name">HttpException</span>
        <span class="token operator">?</span> exception<span class="token punctuation">.</span><span class="token function">getStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">:</span> HttpStatus<span class="token punctuation">.</span>INTERNAL_SERVER_ERROR<span class="token punctuation">;</span>

    response
      <span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span>status<span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        statusCode<span class="token punctuation">:</span> status<span class="token punctuation">,</span>
        timestamp<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toISOString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        path<span class="token punctuation">:</span> request<span class="token punctuation">.</span>url<span class="token punctuation">,</span>
        message<span class="token punctuation">:</span>exception<span class="token punctuation">.</span>message<span class="token punctuation">.</span>error
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<h6 id="7-还可以设置中间件，ts支持棒棒的"><a href="#7-还可以设置中间件，ts支持棒棒的" class="headerlink" title="7.还可以设置中间件，ts支持棒棒的"></a>7.还可以设置中间件，ts支持棒棒的</h6><p>注意:<br>全局缓存CacheInterceptor  不能和GraphQL  一起用（用就报错），因为 GraphQL 本来就有缓存(如：dataloader），是否能和redis一起用  有待考察</p>
</article><br><br><span class="next-post"><a href="/2019/03/05/写bug/" itemprop="url">上一章 ⇒</a></span><span class="prev-post"><a href="/2019/06/25/看了antd源码后/" itemprop="url">⇐ 下一章 </a></span><br><br><br></main></body></html>